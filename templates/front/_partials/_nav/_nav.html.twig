{# templates/partials/_navbar.html.twig #}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
	<div
		class="container-fluid">
		{# Brand #}
		<a class="navbar-brand d-flex align-items-center fw-bold bg-success ps-1 rounded" href="{{ path('app_front_home') }}">
			<img src="{{ asset('assets/images/logo.svg') }}" alt="Logo" height="28" class="me-2">
		</a>

		{# Toggler #}
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor03" aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div
			class="collapse navbar-collapse" id="navbarColor03">
			{# Left: Menus principaux #}
			<ul class="navbar-nav me-auto">
				<li class="nav-item">
					<a class="nav-link fw-bold text-white {% if app.request.attributes.get('_route') == 'app_how_it_works' %}text-decoration-underline{% endif %}" href="{{ path('app_how_it_works') }}">
						Comment √ßa marche ?
					</a>
				</li>

				<li class="nav-item">
					<a class="nav-link fw-bold text-white {% if app.request.attributes.get('_route') == 'app_front_search_ride' %}text-decoration-underline{% endif %}" href="{{ path('app_front_search_ride') }}">
						Trouver un trajet
					</a>
				</li>

				<li class="nav-item">
					<a class="nav-link fw-bold text-white {% if app.request.attributes.get('_route') == 'contact_index' %}text-decoration-underline{% endif %}" href="{{ path('contact_index') }}">
						Contact
					</a>
				</li>
			</ul>

			{# Right section: Wallet + Compte #}
			<ul
				class="navbar-nav ms-auto align-items-center">

				{# üí∞ Bloc Wallet s√©par√© #}
				{% if app.user %}
					<li class="nav-item me-3">
						<div class="d-flex align-items-center bg-success text-white rounded-pill px-3 py-1 border border-success shadow-sm" style="font-size: 0.9rem; border-color:#01D758 !important;">
							<i class="bi bi-wallet2 me-2 text-primary"></i>
							<div class="text-start lh-1">
								<strong id="wallet-balance" class="text-secondary">125.50 ‚Ç¨</strong><br>
								<small id="wallet-transactions" class="text-secondary">(0 transaction)</small>
							</div>
						</div>
					</li>
				{% endif %}

				{# üë§ Dropdown utilisateur #}
				<li class="nav-item dropdown">
					{% if app.user %}
						{% set pseudo = app.user.pseudo ?? (app.user.email|split('@')[0]) %}
						{% set initial = (pseudo|slice(0,1)|upper) %}
						{% set isDriver = 'ROLE_DRIVER' in app.user.roles %}

						<a class="nav-link dropdown-toggle d-flex align-items-center fw-bold text-white" href="#" id="navAccount" role="button" data-bs-toggle="dropdown" aria-expanded="false">
							<span class="rounded-circle d-inline-flex align-items-center justify-content-center me-2 bg-white text-primary" style="width:28px;height:28px;">
								<strong class="small">{{ initial }}</strong>
							</span>
							<span class="d-none d-lg-inline">{{ pseudo }}</span>
						</a>

						<div class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="navAccount" style="min-width: 260px;">
							<a class="dropdown-item fw-semibold {% if app.request.attributes.get('_route') == 'profile_view' %}text-decoration-underline{% endif %}" href="{{ path('profile_view') }}">
								<i class="bi bi-person-circle me-2"></i>
								Mon profil
							</a>

							<a class="dropdown-item fw-semibold" href="#">
								<i class="bi bi-sliders2 me-2"></i>
								Mes pr√©f√©rences
							</a>

							<div class="dropdown-divider"></div>

							{% if isDriver %}
								<a class="dropdown-item fw-semibold {% if app.request.attributes.get('_route') == 'app_add_ride' %}text-decoration-underline{% endif %}" href="#">
									<i class="bi bi-plus-circle me-2"></i>
									Ajouter un trajet
								</a>
							{% else %}
								<a class="dropdown-item fw-semibold {% if app.request.attributes.get('_route') == 'app_participations' %}text-decoration-underline{% endif %}" href="#">
									<i class="bi bi-list-check me-2"></i>
									Voir mes participations
								</a>
							{% endif %}

							<div class="dropdown-divider"></div>

							<a class="dropdown-item fw-semibold text-danger" href="{{ path('app_logout') }}">
								<i class="bi bi-box-arrow-right me-2"></i>
								D√©connexion
							</a>
						</div>

					{% else %}
						<a class="nav-link dropdown-toggle fw-bold text-white {% if app.request.attributes.get('_route') in ['app_login','app_register'] %}text-decoration-underline{% endif %}" href="#" id="navAccount" role="button" data-bs-toggle="dropdown" aria-expanded="false">
							Mon compte
						</a>
						<div class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="navAccount">
							<a class="dropdown-item fw-semibold {% if app.request.attributes.get('_route') == 'app_login' %}text-decoration-underline{% endif %}" href="{{ path('app_login') }}">
								<i class="bi bi-box-arrow-in-right me-2"></i>
								Connexion
							</a>
							<a class="dropdown-item fw-semibold {% if app.request.attributes.get('_route') == 'app_register' %}text-decoration-underline{% endif %}" href="{{ path('app_register') }}">
								<i class="bi bi-person-plus me-2"></i>
								Cr√©er mon compte
							</a>
						</div>
					{% endif %}
				</li>
			</ul>
		</div>
	</div>
</nav>

 <script>
	const walletBalance = document.getElementById('wallet-balance');
	const walletTransactions = document.getElementById('wallet-transactions');

	async function getWallet() {
		const url = "{{ path('app_api_get_wallet') }}";

		try {
			const response = await fetch(url);
			if (!response.ok) {
				throw new Error(`Response status: ${response.status}`);
			}

			const result = await response.json();
			console.log(result);

			// ü™ô Affiche le solde total format√© √† 2 d√©cimales
			walletBalance.textContent = `${result.balance.toFixed(2)} ‚Ç¨`;

			// üí≥ Si une transaction existe, affiche la derni√®re
			if (result.transactions.length > 0) {
				const lastTransaction = result.transactions[result.transactions.length - 1];
				walletTransactions.textContent = `${lastTransaction.amount} ‚Ç¨ (${lastTransaction.type})`;
			} else {
				walletTransactions.textContent = "(0 transaction)";
			}
		} catch (error) {
			console.error(error.message);
		}
	}

	getWallet();
</script>

