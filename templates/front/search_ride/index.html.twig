{% extends 'base.html.twig' %}

{% block title %}Recherche de covoiturages
{% endblock %}

{% block body %}
	<style>
		/* üåà Transition douce sur le fond et la bordure */
		#containerForm {
			border: 3px solid transparent;
			border-radius: 12px;
			transition: border-color 0.6s ease, box-shadow 0.6s ease;
			padding: 10px;
		}

		/* üí° Quand le mode √©co est activ√© */
		#containerForm.eco-active {
			border-color: var(--bs-primary);
			box-shadow: 0 0 20px rgba(var(--bs-primary-rgb), 0.4);
		}

		/* üåø Optionnel : fond l√©g√®rement teint√© */
		#containerForm.eco-active .card {
			background-color: rgba(var(--bs-primary-rgb), 0.08);
		}

		/* Animation subtile (effet ‚Äúrespiration‚Äù du mode √©co) */
		@keyframes ecoPulse {
			0% {
				box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.2);
			}
			50% {
				box-shadow: 0 0 25px rgba(var(--bs-primary-rgb), 0.6);
			}
			100% {
				box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.2);
			}
		}

		#containerForm.eco-active {
			animation: ecoPulse 2s infinite;
		}
	</style>

	<div class="container my-4" id="containerForm">
		<div class="card shadow-sm border-0">
			<div class="card-body">
				<h5 class="card-title mb-3">Filtrer les covoiturages</h5>

				<form
					id="carpool-filter-form" method="get" action="{{ path('carpooling_filter') }}" class="row g-3">
					<!-- Ville de d√©part -->
					<div class="col-md-4">
						<label for="deparatureCity" class="form-label">Ville de d√©part</label>
						<input type="text" class="form-control" id="deparatureCity" name="deparatureCity" placeholder="Ex : Lille">
					</div>

					<!-- Ville d‚Äôarriv√©e -->
					<div class="col-md-4">
						<label for="arrivalCity" class="form-label">Ville d‚Äôarriv√©e</label>
						<input type="text" class="form-control" id="arrivalCity" name="arrivalCity" placeholder="Ex : Paris">
					</div>

					<!-- Date de d√©part -->
					<div class="col-md-4">
						<label for="deparatureAt" class="form-label">Date de d√©part</label>
						<input type="date" class="form-control" id="deparatureAt" name="deparatureAt">
					</div>

					<!-- Places disponibles -->
					<div class="col-md-3">
						<label for="seatsAvaible" class="form-label">Places disponibles (min.)</label>
						<input type="number" min="1" class="form-control" id="seatsAvaible" name="seatsAvaible" placeholder="Ex : 2" value="1">
					</div>

					<!-- Prix -->
					<div class="col-md-3">
						<label for="price" class="form-label">Prix maximum (‚Ç¨)</label>
						<input type="number" min="0" step="1" class="form-control" id="price" name="price" placeholder="Ex : 50">
					</div>

					<!-- √âcoTag -->
					<div class="col-md-3 align-self-end">
						<div class="form-check form-switch">
							<input class="form-check-input" type="checkbox" id="ecoTag" name="ecoTag" value="1">
							<label class="form-check-label" for="ecoTag">Trajet classique üöó</label>
						</div>
					</div>

					<!-- Boutons -->
					<div class="col-md-3 align-self-end d-flex justify-content-end gap-2">
						<button type="reset" class="btn btn-outline-secondary">R√©initialiser</button>
						<button type="submit" class="btn btn-primary">Filtrer</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div id="carpool-results" class="mt-4"></div>

	 <script>
	/* ===========================================================
	   üéØ Effet visuel + filtrage des covoiturages
	=========================================================== */
	
	document.addEventListener("DOMContentLoaded", () => {
	  const form = document.getElementById("carpool-filter-form");
	  const resultsDiv = document.getElementById("carpool-results");
	  const ecoCheckbox = document.getElementById("ecoTag");
	  const containerForm = document.getElementById("containerForm");
	
	  /* üåø Changement visuel du mode √©co */
	  function updateEcoTag() {
	    if (ecoCheckbox.checked) {
	      ecoCheckbox.nextElementSibling.textContent = "Trajet √©cologique üå±";
	      containerForm.classList.add("eco-active");
	    } else {
	      ecoCheckbox.nextElementSibling.textContent = "Trajet classique üöó";
	      containerForm.classList.remove("eco-active");
	    }
	  }
	
	  ecoCheckbox.addEventListener("change", updateEcoTag);
	
	  /* üöó Chargement dynamique des covoiturages */
	  if (form && resultsDiv) {
	    const ROUTE_CARPOOL_DETAILS = "{{ path('app_front_carpooling', {'id': 0}) }}".replace(/0$/, "");
	
	    async function fetchCarpoolings(url) {
	      resultsDiv.innerHTML = `<div class="text-center py-4 text-muted">Chargement...</div>`;
	
	      try {
	        const response = await fetch(url, { headers: { Accept: "application/json" } });
	        const data = await response.json();
	
	        if (!Array.isArray(data) || !data.length) {
	          resultsDiv.innerHTML = `<div class="alert alert-warning container">Aucun covoiturage trouv√©.</div>`;
	          return;
	        }
	
	        resultsDiv.innerHTML = `
	          <div class="container">
	            <div class="row g-4">
	              ${data.map((c) => `
	                <div class="col-12 col-sm-6 col-lg-3">
	                  <div class="card h-100 shadow-sm border-0">
	                    <div class="card-body">
	                      <h5 class="card-title text-primary">${c.deparatureCity} ‚Üí ${c.arrivalCity}</h5>
	                      <p class="card-text mb-1"><strong>Date de d√©part :</strong><br>${new Date(c.deparatureAt).toLocaleString("fr-FR")}</p>
	                      <p class="card-text mb-1"><strong>Places disponibles :</strong> ${c.seatsAvaible ?? 0}</p>
	                      <p class="card-text mb-1"><strong>Prix :</strong> ${c.price} ‚Ç¨</p>
	                      ${c.ecoTag ? '<span class="badge bg-success">√âco</span>' : ""}
	                      <a href="${ROUTE_CARPOOL_DETAILS}${c.id}" class="btn btn-link">
	                        <i class="bi bi-eye"></i> D√©tails
	                      </a>
	                    </div>
	                  </div>
	                </div>`).join("")}
	            </div>
	          </div>`;
	      } catch (error) {
	        console.error(error);
	        resultsDiv.innerHTML = `<div class="alert alert-danger container">Erreur lors du chargement des r√©sultats.</div>`;
	      }
	    }
	
	    // üîπ Soumission du formulaire
	    form.addEventListener("submit", (e) => {
	      e.preventDefault();
	      const params = new URLSearchParams(new FormData(form));
	      const url = "{{ path('carpooling_filter') }}?" + params.toString();
	      fetchCarpoolings(url);
	    });
	
	    // üîπ Si param√®tres dans l‚ÄôURL (retour d‚Äôune autre page)
	    const currentUrl = new URL(window.location.href);
	    if (currentUrl.search) {
	      const url = "{{ path('carpooling_filter') }}" + currentUrl.search;
	      fetchCarpoolings(url);
	    }
	  }
	});
	</script>
{% endblock %}

