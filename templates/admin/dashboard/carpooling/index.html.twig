{# templates/admin/dashboard/carpooling/index.html.twig #}
{% extends 'template.html.twig' %}

{% block title %}Liste covoiturages
{% endblock %}

{# CSS DataTables #}
{% block stylesheets %}
	{{ parent() }}
	<link href="{{ asset('dashboard/vendor/datatables/dataTables.bootstrap4.min.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
	<div class="card shadow mb-4">
		<div class="card-header py-3 d-flex justify-content-between align-items-center">
			<h6 class="m-0 font-weight-bold text-primary">Liste des covoiturages</h6>
			<a class="btn btn-sm btn-primary" href="{{ path('admin_carpooling_new') }}">
				<i class="fas fa-plus"></i>
				Nouveau covoiturage
			</a>
		</div>

		<div class="card-body">
			<table id="carpoolingTable" class="table table-striped table-hover align-middle">
				<thead>
					<tr>
						<th>ID</th>
						<th>Conducteur</th>
						<th>Véhicule</th>
						<th>Trajet</th>
						<th>Départ</th>
						<th>Arrivée</th>
						<th>Places</th>
						<th>Prix (€)</th>
						<th>Statut</th>
						<th>Éco</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for c in carpoolings %}
						{% set depEpoch = c.deparatureAt ? c.deparatureAt|date('U') : '' %}
						<tr>
							<td>{{ c.id }}</td>

							<td>
								{% if c.driver %}
									<a href="{{ path('app_user_show', {id: c.driver.id}) }}">
										{{ c.driver.pseudo ?: c.driver.email }}
									</a>
									{% else %}—
								{% endif %}
							</td>

							<td>
								{% if c.vehicle %}
									<a href="{{ path('app_vehicle_show', {id: c.vehicle.id}) }}">#{{ c.vehicle.id }}</a>
									{% else %}—
								{% endif %}
							</td>

							<td>
								{{ c.deparatureCity ?: '—' }}
								&rarr;
								{{ c.arrivalCity ?: '—' }}
							</td>

							<td data-order="{{ depEpoch }}">
								{{ c.deparatureAt ? c.deparatureAt|date('d/m/Y H:i') : '—' }}
							</td>

							<td>
								{{ c.arrivalAt ? c.arrivalAt|date('d/m/Y H:i') : '—' }}
							</td>

							<td>
								{{ c.seatsAvaible is not null ? c.seatsAvaible : '—' }}/{{ c.seatsTotal ?? '—' }}
							</td>

							<td>
								{{ c.price is not null ? c.price|number_format(2, ',', ' ') : '—' }}
							</td>

							<td>
								{% set statusColors = { 'draft':'secondary', 'published':'success', 'cancelled':'danger' } %}
								<span class="badge badge-{{ statusColors[c.status]|default('secondary') }}">
									{{ c.status|default('—')|capitalize }}
								</span>
							</td>

							<td>
								<span class="badge badge-{{ c.ecoTag ? 'success' : 'light' }}">{{ c.ecoTag ? 'Éco' : '—' }}</span>
							</td>

							<td class="text-nowrap">
								<a class="btn btn-sm btn-outline-primary" href="{{ path('admin_carpooling_show', {'id': c.id}) }}">Voir</a>
								<a class="btn btn-sm btn-outline-warning" href="{{ path('admin_carpooling_edit', {'id': c.id}) }}">Éditer</a>
							</td>
						</tr>
					{% else %}
						<tr>
							<td colspan="11">Aucun covoiturage trouvé</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
 <script src="{{ asset('dashboard/vendor/jquery/jquery.min.js') }}"></script>
	 <script src="{{ asset('dashboard/vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
	 <script src="{{ asset('dashboard/vendor/datatables/jquery.dataTables.min.js') }}"></script>
	 <script src="{{ asset('dashboard/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>

	 <script>
	    function initCarpoolingDT() {
	      if ($.fn.DataTable.isDataTable('#carpoolingTable')) return;
	
	      $('#carpoolingTable').DataTable({
	        responsive: true,
	        pageLength: 10,
	        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'Tous']],
	        order: [[0, 'asc']], // tri par ID
	        language: {
	          processing:     "Traitement en cours...",
	          search:         "Rechercher&nbsp;:",
	          lengthMenu:     "Afficher _MENU_ entrées",
	          info:           "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
	          infoEmpty:      "Affichage de 0 à 0 sur 0 entrée",
	          infoFiltered:   "(filtré de _MAX_ entrées au total)",
	          loadingRecords: "Chargement...",
	          zeroRecords:    "Aucune entrée correspondante trouvée",
	          emptyTable:     "Aucune donnée disponible dans le tableau",
	          paginate: {
	            first: "Premier", previous: "Précédent", next: "Suivant", last: "Dernier"
	          },
	          aria: {
	            sortAscending:  ": activer pour trier la colonne par ordre croissant",
	            sortDescending: ": activer pour trier la colonne par ordre décroissant"
	          }
	        },
	        columnDefs: [
	          { targets: -1, orderable: false, searchable: false } 
	        ]
	      });
	    }
	
	    document.addEventListener('DOMContentLoaded', initCarpoolingDT);
	    document.addEventListener('turbo:load', initCarpoolingDT);
	  </script>
{% endblock %}

