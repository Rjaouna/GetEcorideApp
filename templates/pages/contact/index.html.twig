{% extends 'base.html.twig' %}

{% block title %}Contact
{% endblock %}

{% block body %}
	<div class="container py-5">
		<div class="row justify-content-center">
			<div class="col-md-8 col-lg-6">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-primary text-white text-center">
						<h4 class="mb-0">Contact</h4>
					</div>

					<div class="card-body">
						<p class="text-muted mb-4 text-center">
							Vous avez une question ou une remarque ? Envoyez-nous un message, nous vous répondrons rapidement.
						</p>

						<!-- Zone d’alertes -->
						<div id="contact-alerts" class="mb-3"></div>

						{{ form_start(form, {
            action: path('contact_submit'),
            attr: { id: 'contactForm', novalidate: 'novalidate' }
          }) }}

						<div class="mb-3">
							{{ form_label(form.fullName, 'Nom complet', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
							{{ form_widget(form.fullName, {attr: {class: 'form-control', required: true, autofocus: true}}) }}
							<div class="invalid-feedback d-block" data-error-for="fullName"></div>
						</div>

						<div class="mb-3">
							{{ form_label(form.email, 'Adresse e-mail', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
							{{ form_widget(form.email, {attr: {class: 'form-control', required: true}}) }}
							<div class="invalid-feedback d-block" data-error-for="email"></div>
						</div>

						<div class="mb-4">
							{{ form_label(form.message, 'Message', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
							{{ form_widget(form.message, {attr: {class: 'form-control', rows: 5, required: true}}) }}
							<div class="invalid-feedback d-block" data-error-for="message"></div>
						</div>

						<div class="text-center">
							<button type="submit" class="btn btn-primary px-4" id="contactSubmit">
								Envoyer
							</button>
						</div>

						{{ form_end(form) }}
					</div>
				</div>
			</div>
		</div>
	</div>

	 <script>
	(function () {
	  const form = document.getElementById('contactForm');
	  if (!form) return;
	
	  const alerts   = document.getElementById('contact-alerts');
	  const submitBtn = document.getElementById('contactSubmit');
	
	  function resetErrors() {
	    document.querySelectorAll('[data-error-for]').forEach(el => el.textContent = '');
	  }
	
	  function showFieldErrors(errors) {
	    Object.entries(errors || {}).forEach(([name, messages]) => {
	      const holder = document.querySelector('[data-error-for="' + name + '"]');
	      if (holder) holder.textContent = Array.isArray(messages) ? messages.join(' ') : String(messages);
	    });
	  }
	
	  function showAlert(type, text) {
	    alerts.innerHTML = (
	      '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
	        text +
	        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>' +
	      '</div>'
	    );
	  }
	
	  form.addEventListener('submit', function (e) {
	    e.preventDefault();
	    resetErrors();
	    alerts.innerHTML = '';
	
	    const originalText = submitBtn.textContent;
	    submitBtn.disabled = true;
	    submitBtn.textContent = 'Envoi...';
	
	    const formData = new FormData(form);
	
	    fetch(form.action, {
	      method: 'POST',
	      headers: { 'X-Requested-With': 'XMLHttpRequest' },
	      body: formData
	    })
	    .then(res => res.json().catch(() => {}).then(data => ({ ok: res.ok, status: res.status, data })))
	    .then(res => {
	      if (res.ok && res.data?.ok) {
	        showAlert('success', res.data.message || 'Votre message a été envoyé avec succès.');
	        form.reset();
	      } else if (res.status === 422 && res.data?.errors) {
	        showFieldErrors(res.data.errors);
	        showAlert('danger', 'Merci de corriger les erreurs.');
	      } else {
	        showAlert('danger', res.data?.error || 'Une erreur est survenue. Veuillez réessayer.');
	      }
	    })
	    .catch(() => showAlert('danger', 'Erreur réseau.'))
	    .finally(() => {
	      submitBtn.disabled = false;
	      submitBtn.textContent = originalText;
	    });
	  });
	})();
	</script>
{% endblock %}

