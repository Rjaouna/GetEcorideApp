{% extends 'base.html.twig' %}

{% block title %}Profil
{% endblock %}

{% block body %}
	<div
		class="container py-4">

		{# Flash switch / erreurs #}
		<div id="switch-flash" class="alert alert-warning d-none mt-2"></div>

		{# Bannière driver/passager #}
		<div id="isDriver" class="alert alert-dismissible alert-secondary">
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			<strong>Chargement…</strong>
		</div>

		<div
			id="profile-box" data-url="{{ path('app_profile', { id: userId }) }}">

			{# ==== USER ==== #}
			<div class="mb-4 p-3 bg-body-secondary rounded-3 border" id="user-div">
				<h5 class="mb-3">Utilisateur</h5>
				<div id="user-content">Chargement…</div>
			</div>

			{# ==== VEHICLES ==== #}
			<div class="mb-4 p-3 bg-body-secondary rounded-3 border" id="vehicles-div">
				<h5 class="mb-3">Véhicules</h5>
				<div id="vehicles-content">Chargement…</div>
			</div>

			{# ==== CARPOOLINGS ==== #}
			<div class="mb-4 p-3 bg-body-secondary rounded-3 border" id="carpoolings-div">
				<h5 class="mb-3">Covoiturages</h5>
				<div id="carpoolings-content">Chargement…</div>
			</div>

			<div id="p-error" class="alert alert-danger d-none mt-3"></div>
		</div>
	</div>

	{# ========================= MODAL AJOUT VEHICULE ========================= #}
	<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="vehicleModalLabel">Ajouter un véhicule</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					<form id="vehicle-form">
						<div class="mb-3">
							<label for="vehicle-plate" class="form-label">Immatriculation *</label>
							<input type="text" class="form-control" id="vehicle-plate" required placeholder="AB-123-CD">
						</div>

						<div class="mb-3">
							<label for="vehicle-firstReg" class="form-label">1<sup>re</sup>
								mise en circulation *</label>
							<input type="date" class="form-control" id="vehicle-firstReg" required>
						</div>

						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="vehicle-brand" class="form-label">Marque *</label>
								<input type="text" class="form-control" id="vehicle-brand" required placeholder="Renault">
							</div>
							<div class="col-md-6 mb-3">
								<label for="vehicle-model" class="form-label">Modèle *</label>
								<input type="text" class="form-control" id="vehicle-model" required placeholder="Clio">
							</div>
						</div>

						<div class="mb-3">
							<label for="vehicle-seats" class="form-label">Nombre de places *</label>
							<input type="number" min="1" max="9" step="1" class="form-control" id="vehicle-seats" required placeholder="5">
						</div>

						<div class="form-check form-switch mb-2">
							<input class="form-check-input" type="checkbox" id="vehicle-electric">
							<label class="form-check-label" for="vehicle-electric">Électrique</label>
						</div>

						<div class="form-check form-switch mb-3">
							<input class="form-check-input" type="checkbox" id="vehicle-active" checked>
							<label class="form-check-label" for="vehicle-active">Actif</label>
						</div>

						<div id="vehicle-error" class="alert alert-danger d-none"></div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
					<button type="button" id="vehicle-save" class="btn btn-primary">Enregistrer</button>
				</div>
			</div>
		</div>
	</div>

	{# ========================= SCRIPTS ========================= #}
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	 <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

	 <script>
	(function () {
	  const profileUrl       = document.getElementById('profile-box')?.dataset.url;
	  const switchRoleUrl    = "{{ path('me_switch_role') }}";
	  const vehicleCreateUrl = "{{ path('api_vehicle_create') }}"; // route API création véhicule
	
	  const userEl          = document.getElementById('user-content');
	  const vehEl           = document.getElementById('vehicles-content');
	  const carpEl          = document.getElementById('carpoolings-content');
	  const errEl           = document.getElementById('p-error');
	  const flashEl         = document.getElementById('switch-flash');
	  const isDriverAlert   = document.getElementById('isDriver');
	  const vehiclesDiv     = document.getElementById('vehicles-div');
	  const carpoolingsDiv  = document.getElementById('carpoolings-div');
	
	  // Modal refs
	  const vehicleModalEl  = document.getElementById('vehicleModal');
	  const vehicleModal    = vehicleModalEl ? new bootstrap.Modal(vehicleModalEl) : null;
	  const vehicleForm     = document.getElementById('vehicle-form');
	  const vehicleErrEl    = document.getElementById('vehicle-error');
	  const vehicleSaveBtn  = document.getElementById('vehicle-save');
	
	  // Inputs
	  const el = (id) => document.getElementById(id);
	  const inputPlate     = el('vehicle-plate');
	  const inputFirstReg  = el('vehicle-firstReg');
	  const inputBrand     = el('vehicle-brand');
	  const inputModel     = el('vehicle-model');
	  const inputSeats     = el('vehicle-seats');
	  const inputElectric  = el('vehicle-electric');
	  const inputActive    = el('vehicle-active');
	
	  const fmtDate = (iso) => iso
	    ? new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium', timeStyle:'short', timeZone:'Europe/Paris' }).format(new Date(iso))
	    : '—';
	  const money = (n) => (n==null ? '—' : new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(n));
	  const txt = (v)=> (v ?? '—');
	
	  function showFlash(message, type='warning') {
	    if (!flashEl) return;
	    flashEl.classList.remove('d-none', 'alert-warning', 'alert-danger', 'alert-success', 'alert-info');
	    flashEl.classList.add('alert-' + type);
	    flashEl.innerHTML = message;
	  }
	  function hideFlash() {
	    if (!flashEl) return;
	    flashEl.classList.add('d-none');
	    flashEl.textContent = '';
	  }
	
	  function openVehicleModal() {
	    if (!vehicleModal) return;
	    // reset form & errors
	    vehicleForm?.reset();
	    vehicleErrEl?.classList.add('d-none');
	    vehicleErrEl && (vehicleErrEl.textContent = '');
	    vehicleModal.show();
	  }
	
	  async function saveVehicleAndMaybeSwitch() {
	    const plate    = inputPlate.value.trim();
	    const firstReg = inputFirstReg.value; // "YYYY-MM-DD"
	    const brand    = inputBrand.value.trim();
	    const model    = inputModel.value.trim();
	    const seatsVal = inputSeats.value;
	    const isElectric = inputElectric.checked;
	    const isActive   = inputActive.checked;
	
	    // validations front
	    const errors = [];
	    if (!plate)    errors.push('Immatriculation obligatoire.');
	    if (!firstReg) errors.push('Date de première mise en circulation obligatoire.');
	    if (!brand)    errors.push('Marque obligatoire.');
	    if (!model)    errors.push('Modèle obligatoire.');
	    const seats = parseInt(seatsVal, 10);
	    if (!Number.isInteger(seats) || seats < 1 || seats > 9) errors.push('Nombre de places invalide (1–9).');
	
	    if (errors.length) {
	      vehicleErrEl.classList.remove('d-none');
	      vehicleErrEl.innerHTML = errors.map(e => `<div>${e}</div>`).join('');
	      return;
	    }
	
	    vehicleSaveBtn?.classList.add('disabled');
	
	    try {
	      await axios.post(
	        vehicleCreateUrl,
	        {
	          plateNumber: plate,
	          firstRegistrationAt: firstReg,
	          brand: brand,
	          model: model,
	          seats: seats,
	          isElectric: isElectric,
	          isActive: isActive
	        },
	        { headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' } }
	      );
	
	      vehicleModal?.hide();
	      showFlash('<strong>Succès :</strong> véhicule ajouté.', 'success');
	
	      // recharger le profil
	      await loadProfile();
	
	      // switch auto en driver (optionnel)
	      try {
	        await axios.post(switchRoleUrl, {}, { headers: { 'Accept': 'application/json' } });
	        await loadProfile();
	        showFlash('<strong>Succès :</strong> mode driver activé.', 'success');
	      } catch (_) {}
	
	    } catch (err) {
	      const status = err?.response?.status;
	      const apiMsg = err?.response?.data?.message || 'Erreur lors de la création du véhicule.';
	      vehicleErrEl.classList.remove('d-none');
	      vehicleErrEl.textContent = (status ? `[${status}] ` : '') + apiMsg;
	    } finally {
	      vehicleSaveBtn?.classList.remove('disabled');
	    }
	  }
	
	  // Bannière avec lien switch
	  function renderBanner({ isDriver, cars, active }) {
	    isDriverAlert.classList.toggle('alert-success', isDriver);
	    isDriverAlert.classList.toggle('alert-warning', !isDriver);
	    isDriverAlert.classList.remove('alert-secondary');
	
	    isDriverAlert.innerHTML = `
	      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	      <strong>${isDriver ? 'Mode driver activé !' : 'Mode passager'}</strong>
	      <span class="ms-2">
	        ${isDriver
	          ? `Voitures : <b>${cars}</b> — Covoiturages actifs : <b>${active}</b>`
	          : 'Vous ne voyez pas les véhicules/covoiturages en mode passager.'}
	      </span>
	      <a href="#" id="switch-role" class="alert-link ms-2">Basculer de mode</a>.
	    `;
	
	    const btn = document.getElementById('switch-role');
	    if (!btn) return;
	
	    btn.addEventListener('click', async (e) => {
	      e.preventDefault();
	      hideFlash();
	      btn.classList.add('disabled');
	
	      try {
	        await axios.post(switchRoleUrl, {}, {
	          headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
	        });
	        await loadProfile();
	        showFlash('<strong>Succès :</strong> votre mode a été basculé.', 'success');
	      } catch (err) {
	        const status = err?.response?.status;
	        const apiMsg = err?.response?.data?.message;
	        const action = err?.response?.data?.action;
	
	        if (status === 422) {
	          if (action?.type === 'modal') {
	            openVehicleModal();
	          }
	          const cta = `<button type="button" class="btn btn-sm btn-primary ms-2" id="open-add-vehicle">Ajouter un véhicule</button>`;
	          showFlash(`<strong>Attention :</strong> ${apiMsg ?? 'Aucun véhicule.'}${cta}`, 'warning');
	
	          // bouton pour ouvrir le modal depuis le flash
	          setTimeout(() => {
	            const ctabtn = document.getElementById('open-add-vehicle');
	            ctabtn && ctabtn.addEventListener('click', (ev) => {
	              ev.preventDefault();
	              openVehicleModal();
	            });
	          }, 0);
	        } else {
	          showFlash(`<strong>Erreur :</strong> ${status ? 'HTTP '+status : 'Problème réseau'}`, 'danger');
	        }
	      } finally {
	        btn.classList.remove('disabled');
	      }
	    });
	  }
	
	  // Charge profil + meta
	  async function loadProfile() {
	    hideFlash();
	    try {
	      const { data } = await axios.get(profileUrl, { headers: { Accept: 'application/json' } });
	      const user = data.user;
	      const meta = data.meta || {};
	
	      renderBanner({
	        isDriver: !!meta.isDriver,
	        cars: meta.vehiclesCount ?? (Array.isArray(user.vehicles) ? user.vehicles.length : 0),
	        active: meta.activeCarpoolings ?? 0,
	      });
	
	      if (vehiclesDiv)    vehiclesDiv.classList.toggle('d-none', !meta.isDriver);
	      if (carpoolingsDiv) carpoolingsDiv.classList.toggle('d-none', !meta.isDriver);
	
	      const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || '—';
	      userEl.innerHTML = `
	        <div class="row gy-2">
	          <div class="col-12 col-md-6"><strong>Nom :</strong> ${fullName}</div>
	          <div class="col-12 col-md-6"><strong>Pseudo :</strong> ${txt(user.pseudo)}</div>
	          <div class="col-12 col-md-6"><strong>Email :</strong> ${txt(user.email)}</div>
	          <div class="col-12 col-md-6"><strong>Téléphone :</strong> ${txt(user.phone)}</div>
	          <div class="col-12"><strong>Adresse :</strong> ${txt(user.address)}</div>
	          <div class="col-12 col-md-6"><strong>Date de naissance :</strong> ${fmtDate(user.dateOfBirth)}</div>
	        </div>
	      `;
	
	      const vehicles = Array.isArray(user.vehicles) ? user.vehicles : [];
	      vehEl.innerHTML = vehicles.length
	        ? vehicles.map(v => `
	            <div class="border rounded-2 p-2 mb-2 bg-white">
	              <div><strong>Immatriculation :</strong> ${txt(v.plateNumber)}</div>
	              <div><strong>Mise en circ. :</strong> ${fmtDate(v.firstRegistrationAt)}</div>
	              <div><strong>Marque/Modèle :</strong> ${txt(v.brand)} ${txt(v.model)}</div>
	              <div><strong>Places :</strong> ${txt(v.seats)} ${v.isElectric ? '<span class="badge bg-success ms-2">Électrique</span>' : ''}</div>
	              <div><strong>Statut :</strong> ${v.isActive ? '<span class="badge bg-primary">Actif</span>' : '<span class="badge bg-secondary">Inactif</span>'}</div>
	            </div>
	          `).join('')
	        : 'Aucun véhicule';
	
	      const carp = Array.isArray(user.carpoolings) ? user.carpoolings : [];
	      carpEl.innerHTML = carp.length
	        ? carp.map(c => {
	            const seats = `${c.seatsAvaible ?? c.seatsAvailable ?? '—'} / ${c.seatsTotal ?? '—'}`;
	            const eco = c.ecoTag ? '<span class="badge bg-success ms-2">Éco</span>' : '';
	            const badge = (s => {
	              const k = (s||'').toLowerCase();
	              if (k==='published') return 'bg-success';
	              if (k==='cancelled') return 'bg-danger';
	              return 'bg-secondary';
	            })(c.status);
	            return `
	              <div class="border rounded-2 p-2 mb-2 bg-white">
	                <div class="d-flex flex-wrap align-items-center mb-1">
	                  <strong class="me-2">${txt(c.deparatureCity)} → ${txt(c.arrivalCity)}</strong>
	                  ${eco}
	                  <span class="badge ${badge} ms-auto">${txt(c.status)}</span>
	                </div>
	                <div class="row gy-1">
	                  <div class="col-12 col-md-4"><strong>Départ :</strong> ${fmtDate(c.deparatureAt)}</div>
	                  <div class="col-12 col-md-4"><strong>Arrivée :</strong> ${fmtDate(c.arrivalAt)}</div>
	                  <div class="col-12 col-md-4"><strong>Places :</strong> ${seats}</div>
	                  <div class="col-12 col-md-4"><strong>Prix :</strong> ${money(c.price)}</div>
	                  <div class="col-12 col-md-8"><strong>Véhicule :</strong> ${txt(c?.vehicle?.plateNumber)}</div>
	                </div>
	              </div>
	            `;
	          }).join('')
	        : 'Aucun covoiturage';
	
	    } catch (e) {
	      let msg = 'Erreur réseau';
	      if (e.response) {
	        msg = `Erreur ${e.response.status}`;
	        if (e.response.status === 401) msg += ' — non authentifié';
	        if (e.response.status === 403) msg += ' — accès interdit';
	        if (e.response.status === 404) msg += ' — profil introuvable';
	      }
	      errEl.textContent = msg;
	      errEl.classList.remove('d-none');
	      userEl.textContent = 'Impossible de charger les infos utilisateur.';
	      vehEl.textContent = 'Impossible de charger les véhicules.';
	      carpEl.textContent = 'Impossible de charger les covoiturages.';
	    }
	  }
	
	  // bouton "Enregistrer" du modal
	  document.getElementById('vehicle-save')?.addEventListener('click', (e) => {
	    e.preventDefault();
	    saveVehicleAndMaybeSwitch();
	  });
	
	  // 1er chargement
	  loadProfile();
	})();
	</script>
{% endblock %}

