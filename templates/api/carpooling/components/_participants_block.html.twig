 <script>
document.addEventListener('DOMContentLoaded', async () => {
  const id = {{ id ?? 'null' }};
  if (!id) return;

  const container = document.getElementById('participants-block');
  const joinButton = document.getElementById('join-carpooling-btn');
  const carpoolingUrl = "{{ path('api_carpooling_show', { id: 0 }) }}".replace('/0', `/${id}`);
  let isParticipant = false;

  // ðŸ”„ Fonction de rechargement des participants
  async function reloadParticipants() {
    container.innerHTML = `
      <div class="text-center text-muted py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <div>Chargement des participants...</div>
      </div>
    `;

    const response = await fetch(carpoolingUrl);
    const ride = await response.json();
    const participants = ride.participants ?? [];

    container.innerHTML = `
<div class="card border-0 shadow-sm rounded-4 overflow-hidden">

        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="bi bi-people-fill fs-4 me-2"></i>
          <h5 class="mb-0">Participants (${participants.length})</h5>
        </div>

        <div class="card-body bg-light">
          ${
            participants.length > 0
              ? `
              <ul class="list-group list-group-flush">
                ${participants.map(p => `
                  <li class="list-group-item d-flex align-items-center border-0 border-bottom">
                    <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3" 
                      style="width:45px; height:45px; font-weight:bold;">
                      ${p.firstName?.charAt(0).toUpperCase() ?? '?'}
                    </div>
                    <div>
                      <span class="fw-semibold">${p.firstName} ${p.lastName}</span><br>
                      <small class="text-muted">${p.email ?? ''}</small>
                    </div>
                  </li>`).join('')}
              </ul>`
              : `
              <div class="text-center py-4 text-muted">
                <i class="bi bi-person-x fs-1 d-block mb-2"></i>
                <p class="mb-0">Aucun participant pour le moment.</p>
              </div>`
          }
        </div>
      </div>
    `;
  }

  // ðŸ” Chargement initial
  await reloadParticipants();

  // ðŸ§© Gestion du bouton "Participer / Se dÃ©sinscrire"
  if (!joinButton) return;

  joinButton.addEventListener('click', async () => {
    try {
      joinButton.disabled = true;
      joinButton.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isParticipant ? 'DÃ©sinscription...' : 'Inscription...'}`;

      const endpoint = isParticipant
        ? `/api/carpoolings/${id}/leave`
        : `/api/carpoolings/${id}/join`;

      const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await response.json();

      if (response.ok) {
        isParticipant = !isParticipant;
        await reloadParticipants();

joinButton.classList.toggle('btn-success', isParticipant);

joinButton.classList.toggle('btn-success', !isParticipant);

        joinButton.textContent = isParticipant
          ? 'Se dÃ©sinscrire du covoiturage'
          : 'Participer Ã  ce covoiturage';
      } else {
joinButton.classList.add('btn-success');

        joinButton.textContent = data.message || 'Erreur inconnue';
      }
    } catch (error) {
      console.error(error);
      joinButton.classList.add('btn-danger');
      joinButton.textContent = 'Erreur rÃ©seau';
    } finally {
      joinButton.disabled = false;
    }
  });
});
</script>

